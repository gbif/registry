<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.gbif.registry.persistence.mapper.OccurrenceDownloadMapper">

  <!-- Maps an occurrence download and handles the different types of downloads -->
  <resultMap id="OCCURRENCE_DOWNLOAD_MAP_BASIC" type="org.gbif.api.model.occurrence.Download" autoMapping="false">
    <id property="key" column="key"/>
    <result property="doi" column="doi" />
    <result property="license" column="license"/>
    <result property="status" column="status"/>
    <result property="downloadLink" column="download_link"/>
    <result property="size" column="size"/>
    <result property="totalRecords" column="total_records"/>
    <result property="created" column="created"/>
    <result property="modified" column="modified"/>
    <result property="eraseAfter" column="erase_after"/>
    <result property="erasureNotification" column="erasure_notification"/>
    <result property="source" column="source"/>

    <association property="request" javaType="org.gbif.api.model.occurrence.DownloadRequest">
      <result property="notificationAddressesAsString" column="notification_addresses"/>
      <result property="sendNotification" column="send_notification"/>
      <result property="creator" column="created_by" />
      <result property="format" column="format"/>
      <result property="type" column="type"/>
      <result property="machineDescription" column="machine_description" typeHandler="org.gbif.registry.persistence.mapper.handler.MachineDescriptorTypeHandler"/>
      <result property="description" column="description" />
      <result property="checklistKey" column="checklist_key"/>
      <discriminator javaType="string" column="format">
        <case value="DWCA" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="SIMPLE_CSV" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="SIMPLE_AVRO" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="SIMPLE_PARQUET" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="SIMPLE_WITH_VERBATIM_AVRO" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="SPECIES_LIST" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="MAP_OF_LIFE" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="BIONOMIA" resultType="org.gbif.api.model.occurrence.PredicateDownloadRequest">
          <result property="predicate" column="filter" typeHandler="org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler" />
          <result property="verbatimExtensions" column="verbatim_extensions" typeHandler="ExtensionArrayTypeHandler"/>
          <result property="interpretedExtensions" column="interpreted_extensions" typeHandler="ExtensionArrayTypeHandler"/>
        </case>
        <case value="SQL_TSV_ZIP" resultType="org.gbif.api.model.occurrence.SqlDownloadRequest">
          <result property="sql" column="filter" />
        </case>
      </discriminator>
    </association>
  </resultMap>

  <resultMap id="OCCURRENCE_DOWNLOAD_MAP"
             type="org.gbif.api.model.occurrence.Download" extends="OCCURRENCE_DOWNLOAD_MAP_BASIC">
    <association property="numberDatasets" column="key" select="COUNT_DATASETS" fetchType="eager"/>
  </resultMap>

  <resultMap id="OCCURRENCE_DOWNLOAD_WITH_COUNTS_MAP"
             type="org.gbif.api.model.occurrence.Download" extends="OCCURRENCE_DOWNLOAD_MAP_BASIC">
    <association property="numberDatasets" column="key" select="COUNT_DATASETS" fetchType="eager"/>
    <association property="numberOrganizations" column="key" select="COUNT_ORGANIZATIONS" fetchType="eager"/>
    <association property="numberPublishingCountries" column="key" select="COUNT_PUBLISHING_COUNTRIES" fetchType="eager"/>
  </resultMap>

  <select id="COUNT_DATASETS" resultType="Long">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.COUNT_DATASETS_QUERY"/>
  </select>

  <select id="COUNT_ORGANIZATIONS" resultType="Long">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.COUNT_ORGANIZATIONS_QUERY"/>
  </select>

  <select id="COUNT_PUBLISHING_COUNTRIES" resultType="Long">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.COUNT_PUBLISHING_COUNTRIES_QUERY"/>
  </select>

  <select id="get" resultType="org.gbif.api.model.occurrence.Download" resultMap="OCCURRENCE_DOWNLOAD_MAP">
    SELECT <include refid="org.gbif.registry.persistence.mapper.CommonDownload.OCCURRENCE_DOWNLOAD_FIELDS"/>
    FROM occurrence_download
    WHERE key = #{key,jdbcType=VARCHAR}
  </select>

  <select id="getWithCounts" resultType="org.gbif.api.model.occurrence.Download"
          resultMap="OCCURRENCE_DOWNLOAD_WITH_COUNTS_MAP">
    SELECT <include refid="org.gbif.registry.persistence.mapper.CommonDownload.OCCURRENCE_DOWNLOAD_FIELDS"/>
    FROM occurrence_download
    WHERE key = #{key,jdbcType=VARCHAR}
  </select>

  <select id="getByDOI" resultType="org.gbif.api.model.occurrence.Download" resultMap="OCCURRENCE_DOWNLOAD_MAP">
    SELECT <include refid="org.gbif.registry.persistence.mapper.CommonDownload.OCCURRENCE_DOWNLOAD_FIELDS"/>
    FROM occurrence_download
    WHERE doi = #{doi,jdbcType=VARCHAR}
  </select>

  <sql id="OCCURRENCE_DOWNLOAD_FIELD_TYPES">
    #{key,jdbcType=VARCHAR},
    #{doi,jdbcType=VARCHAR},
    #{license,jdbcType=OTHER},
    <choose>
      <when test="request.format.name().equals('SQL_TSV_ZIP')"> #{request.sql,jdbcType=VARCHAR},</when>
      <otherwise>#{request.predicate,jdbcType=VARCHAR,typeHandler=org.gbif.registry.persistence.mapper.handler.OccurrencePredicateTypeHandler},</otherwise>
    </choose>
    #{status,jdbcType=OTHER},
    #{downloadLink,jdbcType=VARCHAR},
    #{size,jdbcType=BIGINT},
    #{totalRecords,jdbcType=INTEGER},
    #{request.notificationAddressesAsString,jdbcType=VARCHAR},
    #{request.creator,jdbcType=VARCHAR},
    #{request.sendNotification,jdbcType=BOOLEAN},
    #{request.format,jdbcType=OTHER},
    now(), <!-- created -->
    now(), <!-- modified -->
    #{eraseAfter,jdbcType=TIMESTAMP},
    #{erasureNotification,jdbcType=TIMESTAMP},
    #{request.type,jdbcType=OTHER},
    <choose>
      <when test="request.format.name().equals('SQL_TSV_ZIP')">NULL,</when>
      <otherwise>#{request.verbatimExtensions,jdbcType=ARRAY,typeHandler=ExtensionArrayTypeHandler},</otherwise>
    </choose>
    <choose>
      <when test="request.format.name().equals('SQL_TSV_ZIP')">NULL,</when>
      <otherwise>#{request.interpretedExtensions,jdbcType=ARRAY,typeHandler=ExtensionArrayTypeHandler},</otherwise>
    </choose>
    #{source,jdbcType=VARCHAR},
    #{request.description, jdbcType=VARCHAR},
    #{request.machineDescription,jdbcType=OTHER,typeHandler=org.gbif.registry.persistence.mapper.handler.MachineDescriptorTypeHandler}::jsonb,
    #{request.checklistKey, jdbcType=VARCHAR}
  </sql>

  <insert id="create" parameterType="org.gbif.api.model.occurrence.Download">
    INSERT INTO occurrence_download(<include refid="org.gbif.registry.persistence.mapper.CommonDownload.OCCURRENCE_DOWNLOAD_FIELDS"/>)
    VALUES(<include refid="OCCURRENCE_DOWNLOAD_FIELD_TYPES"/>)
  </insert>

  <update id="update" parameterType="org.gbif.api.model.occurrence.Download">
    UPDATE occurrence_download
    SET <include refid="org.gbif.registry.persistence.mapper.CommonDownload.OCCURRENCE_DOWNLOAD_UPDATE_STATUS"/>
    WHERE key = #{key,jdbcType=VARCHAR}
  </update>

  <update id="updateNotificationAddresses">
    UPDATE occurrence_download
    SET <include refid="org.gbif.registry.persistence.mapper.CommonDownload.OCCURRENCE_DOWNLOAD_UPDATE_NOTIFICATION_ADDRESSES"/>
    WHERE created_by = #{oldCreator,jdbcType=VARCHAR}
  </update>

  <!-- Append safe ordering -->
  <select id="listByUser" resultType="org.gbif.api.model.occurrence.Download" resultMap="OCCURRENCE_DOWNLOAD_MAP">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_BY_USER_QUERY"/>
  </select>

  <select id="countByUser" resultType="Integer">
    SELECT COUNT(*)
    FROM occurrence_download
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_BY_USER_COMMON" />
  </select>

  <select id="listByUserLightweight" resultType="org.gbif.api.model.occurrence.Download"
          resultMap="OCCURRENCE_DOWNLOAD_MAP_BASIC">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_BY_USER_LIGHTWEIGHT_QUERY"/>
  </select>

  <!-- Append safe ordering -->
  <select id="list" resultType="org.gbif.api.model.occurrence.Download" resultMap="OCCURRENCE_DOWNLOAD_MAP">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_QUERY"/>
  </select>

  <select id="count" resultType="Integer">
    SELECT COUNT(*)
    FROM occurrence_download
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_WHERE"/>
  </select>

  <select id="listByEraseAfter" resultType="org.gbif.api.model.occurrence.Download" resultMap="OCCURRENCE_DOWNLOAD_MAP">
    <bind name="downloadTable" value="'occurrence'"/>
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_BY_ERASE_AFTER_QUERY"/>
  </select>

  <select id="countByEraseAfter" resultType="Integer">
    SELECT COUNT(*)
    FROM occurrence_download
    <include refid="org.gbif.registry.persistence.mapper.CommonDownload.LIST_BY_ERASE_AFTER_WHERE"/>
  </select>

  <update id="updateLicense">
    UPDATE occurrence_download
    SET license = #{license,jdbcType=OTHER}
    WHERE key = #{key,jdbcType=VARCHAR}
  </update>

  <update id="updateTotalRecords">
    UPDATE occurrence_download
    SET total_records = #{totalRecords,jdbcType=INTEGER}
    WHERE key = #{key,jdbcType=VARCHAR}
  </update>

  <update id="updateLicenseAndTotalRecords">
    UPDATE occurrence_download
    SET license = #{license,jdbcType=OTHER},
        total_records = #{totalRecords,jdbcType=INTEGER}
    WHERE key = #{key,jdbcType=VARCHAR}
  </update>

</mapper>
