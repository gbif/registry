<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.gbif.registry.persistence.mapper.GrScicollVocabFacetMapper">

  <insert id="create" parameterType="org.gbif.registry.persistence.dto.GrSciCollVocabFacetDto" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO grscicoll_vocab_facet (vocabulary_name, name, path)
    VALUES (
      #{vocabularyName,jdbcType=VARCHAR},
      #{name,jdbcType=VARCHAR},
      #{path,jdbcType=OTHER,typeHandler=org.gbif.registry.persistence.facet.LtreeTypeHandler}
    )
  </insert>

  <update id="update" parameterType="org.gbif.registry.persistence.dto.GrSciCollVocabFacetDto">
    UPDATE grscicoll_vocab_facet
    SET
      vocabulary_name = #{vocabularyName,jdbcType=VARCHAR},
      name = #{name,jdbcType=VARCHAR},
      path = #{path,jdbcType=OTHER,typeHandler=org.gbif.registry.persistence.facet.LtreeTypeHandler}
    WHERE
      id = #{id,jdbcType=INTEGER}
  </update>

  <delete id="deleteByVocabularyName">
    DELETE FROM grscicoll_vocab_facet
    WHERE vocabulary_name = #{vocabularyName,jdbcType=VARCHAR}
  </delete>

  <!-- Get facet ID by vocabulary name and facet name -->
  <select id="getFacetIdByVocabularyAndName" resultType="java.lang.Integer">
    SELECT id
    FROM grscicoll_vocab_facet
    WHERE vocabulary_name = #{vocabularyName,jdbcType=VARCHAR}
      AND name = #{facetName,jdbcType=VARCHAR}
  </select>

  <!-- Insert institution facet link -->
  <insert id="insertInstitutionFacetLink">
    INSERT INTO institution_facet_links (institution_key, facet_id)
    VALUES (
      #{institutionKey,jdbcType=OTHER},
      #{facetId,jdbcType=INTEGER}
    )
    ON CONFLICT (institution_key, facet_id) DO NOTHING
  </insert>

  <!-- Delete all facet links for an institution -->
  <delete id="deleteInstitutionFacetLinks">
    DELETE FROM institution_facet_links
    WHERE institution_key = #{institutionKey,jdbcType=OTHER}
  </delete>

  <!-- Insert collection facet link -->
  <insert id="insertCollectionFacetLink">
    INSERT INTO collection_facet_links (collection_key, facet_id)
    VALUES (
      #{collectionKey,jdbcType=OTHER},
      #{facetId,jdbcType=INTEGER}
    )
    ON CONFLICT (collection_key, facet_id) DO NOTHING
  </insert>

  <!-- Delete all facet links for a collection -->
  <delete id="deleteCollectionFacetLinks">
    DELETE FROM collection_facet_links
    WHERE collection_key = #{collectionKey,jdbcType=OTHER}
  </delete>

</mapper>
